# RusBridgeBot (Python)

Telegram-–±–æ—Ç –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫ —Å –æ–ø–ª–∞—Ç–æ–π —á–µ—Ä–µ–∑ Robokassa, –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π –∞–¥–º–∏–Ω–∫–æ–π –≤ Telegram –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ SQLite.

## –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ v1

1. –î–µ–Ω—å–≥–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ webhook (`/payment/robokassa/result`).
2. –°–∫—Ä–∏–Ω—à–æ—Ç –æ–ø–ª–∞—Ç—ã –Ω–µ –Ω—É–∂–µ–Ω; –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–ø–æ—Ä–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö.
3. –£ –∫–∞–∂–¥–æ–≥–æ –∑–∞–∫–∞–∑–∞ –µ—Å—Ç—å `order_id` –∏ —Å—Ç—Ä–æ–≥–∏–π `status`.
4. –û–¥–∏–Ω –∞–∫—Ç–∏–≤–Ω—ã–π –∑–∞–∫–∞–∑ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–æ–¥—É–∫—Ç (`tg_id + product_code`).
5. –°—Å—ã–ª–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –ø–æ —Ñ–æ—Ä–º–∞—Ç—É URL –∏ allowlist-–¥–æ–º–µ–Ω–∞–º –ø—Ä–æ–¥—É–∫—Ç–∞.
6. –í—Å–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –∏–¥—É—Ç –∏–∑ –∞–¥–º–∏–Ω-–≥—Ä—É–ø–ø—ã —á–µ—Ä–µ–∑ inline-–∫–Ω–æ–ø–∫–∏.
7. –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –∫–æ—Ä–æ—Ç–∫–∏–µ —à–∞–≥–∏: –æ–ø–ª–∞—Ç–∏—Ç—å -> –ø—Ä–∏—Å–ª–∞—Ç—å —Å—Å—ã–ª–∫—É -> –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å.
8. –í –∫–∞–∂–¥–æ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –æ–¥–Ω–æ —Ü–µ–ª–µ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ; —Å–ª—É–∂–µ–±–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ –∫–æ–º–∞–Ω–¥—ã.

## –°—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–∞

- `NEW`
- `WAIT_PAY`
- `PAID`
- `WAIT_SERVICE_LINK`
- `READY_FOR_OPERATOR`
- `IN_PROGRESS`
- `DONE`
- `WAIT_CLIENT_CONFIRM`
- `CLIENT_CONFIRMED`
- `ERROR`
- `EXPIRED`
- `CANCELLED`

`WAIT_CLIENT_CONFIRM` –¥–æ–±–∞–≤–ª–µ–Ω —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ, —á—Ç–æ–±—ã —Ä–∞–∑–¥–µ–ª–∏—Ç—å "–æ–ø–µ—Ä–∞—Ç–æ—Ä –∑–∞–≤–µ—Ä—à–∏–ª" –∏ "–∫–ª–∏–µ–Ω—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª, —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç".

## –ü–æ—Ç–æ–∫ –∫–ª–∏–µ–Ω—Ç–∞

1. `/start <key>` (–Ω–∞–ø—Ä–∏–º–µ—Ä `gpt_plus_1m`) -> –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞.
2. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ + –≤—ã–¥–∞—á–∞ —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–ø–ª–∞—Ç—É -> `WAIT_PAY`.
3. –ü–æ—Å–ª–µ webhook `PAID` -> `WAIT_SERVICE_LINK`.
4. –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É –æ–ø–ª–∞—Ç—ã —Å–µ—Ä–≤–∏—Å–∞.
5. –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏ -> `READY_FOR_OPERATOR` –∏ –∫–∞—Ä—Ç–æ—á–∫–∞ –≤ –∞–¥–º–∏–Ω-–≥—Ä—É–ø–ø—É.
6. –û–ø–µ—Ä–∞—Ç–æ—Ä: `CLAIM` -> `IN_PROGRESS` -> `DONE` -> `WAIT_CLIENT_CONFIRM`.
7. –ö–ª–∏–µ–Ω—Ç –Ω–∞–∂–∏–º–∞–µ—Ç `–ê–∫—Ç–∏–≤–Ω–æ` -> `CLIENT_CONFIRMED` –∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è/–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `subscription`.

–ö–æ–º–∞–Ω–¥—ã –∫–ª–∏–µ–Ω—Ç–∞:

- `/status [order_id]` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å.
- `/cancel <order_id>` - –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑ –¥–æ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —ç—Ç–∞–ø–æ–≤.
- `/operator` - –ø–æ–∑–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞.

## –ü–æ—Ç–æ–∫ –∞–¥–º–∏–Ω–∫–∏

–í –∞–¥–º–∏–Ω-–≥—Ä—É–ø–ø—É —É—Ö–æ–¥—è—Ç –∫–∞—Ä—Ç–æ—á–∫–∏:

- `NEW LEAD`
- `PAYMENT CONFIRMED`
- `SERVICE LINK RECEIVED`
- —Ç–∞–π–º–∞—É—Ç—ã/–æ—à–∏–±–∫–∏

–ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

- `CLAIM`
- `IN_PROGRESS`
- `DONE`
- `ERROR`
- `SEND TEMPLATE`

## Robokassa

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:

- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏ –æ–ø–ª–∞—Ç—ã.
- –ü–æ–¥–ø–∏—Å—å `SignatureValue` (–∞–ª–≥–æ—Ä–∏—Ç–º –∑–∞–¥–∞—ë—Ç—Å—è `ROBOCASSA_HASH_ALGO`, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `md5`).
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhook –Ω–∞ `PASSWORD_2`.
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö webhook.

–í–∞–∂–Ω–æ:

- `ResultURL` –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —É—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç—ë–∂.
- `FAIL/EXPIRED` –Ω–µ —Å—á–∏—Ç–∞—é—Ç—Å—è webhook-—Å–æ–±—ã—Ç–∏—è–º–∏ –æ–ø–ª–∞—Ç—ã –≤ –º–æ–¥–µ–ª–∏ –∑–∞–∫–∞–∑–∞.
- `EXPIRED` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º —Ç–∞–π–º–∞—É—Ç–æ–º (`WAIT_PAY_TIMEOUT_MINUTES`, `WAIT_SERVICE_LINK_TIMEOUT_HOURS`).

## Test mode (–¥–æ –±–æ–µ–≤–æ–≥–æ –¥–æ–º–µ–Ω–∞)

–ï—Å–ª–∏ `PAYMENT_TEST_MODE=true`:

- Robokassa –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è.
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∑–∞–≥–ª—É—à–∫–∏:
  - `MOCK_PAYMENT_SUCCESS_URL`
  - `MOCK_PAYMENT_FAIL_URL`
- –ü–æ—è–≤–ª—è–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ `üß™ –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –æ–ø–ª–∞—Ç—É`, –∫–æ—Ç–æ—Ä–∞—è –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –∑–∞–∫–∞–∑ –≤ paid-–ø–æ—Ç–æ–∫ –±–µ–∑ –≤–Ω–µ—à–Ω–µ–≥–æ webhook.

## –¢–∞–±–ª–∏—Ü—ã SQLite

- `users`
- `orders`
- `subscriptions`
- `admin_actions`
- `events_log`

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–º. `.env.example`.

–û—Å–Ω–æ–≤–Ω—ã–µ:

- `RUSBRIDGEBOT_TOKKEN`
- `RUSBRIDGECANNAL_CHAT_ID`
- `USER_CHAT_ID`
- `ID_MAGAZIN_ROBOCASSA`
- `PASSWORD_1`
- `PASSWORD_2`
- `RESULT_URL`
- `SUCCESS_URL`
- `FAIL_URL`
- `PAYMENT_TEST_MODE`

## –ó–∞–ø—É—Å–∫

```bash
python -m venv .venv
.venv\Scripts\activate
pip install -r requirements.txt
python -m app.main
```

## Railway

- `Procfile` –∏ `railway.json` —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –ø—Ä–æ–µ–∫—Ç.
- –ü–æ—à–∞–≥–æ–≤—ã–π –¥–µ–ø–ª–æ–π: `DEPLOY_RAILWAY.md`.

## –¢–µ—Å—Ç—ã

```bash
python -m pytest -q
```

–ü–æ–∫—Ä—ã—Ç–æ unit-—Ç–µ—Å—Ç–∞–º–∏:

- state machine –ø–µ—Ä–µ—Ö–æ–¥—ã
- –≤–∞–ª–∏–¥–∞—Ü–∏—è service-link
- –ø–æ–¥–ø–∏—Å—å Robokassa
- –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç "–æ–¥–∏–Ω –∞–∫—Ç–∏–≤–Ω—ã–π –∑–∞–∫–∞–∑ –Ω–∞ —Å–µ—Ä–≤–∏—Å"
- –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å paid-webhook
